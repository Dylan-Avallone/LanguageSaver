<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Practice: Ser vs. Estar</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f4f4f9;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .sentence {
      font-size: 2.5rem;
      font-weight: bold;
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .buttons {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .feedback {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .feedback.correct {
      color: #28a745; /* Green */
    }
    .feedback.incorrect {
      color: #dc3545; /* Red */
    }
    /* Styling for highlighted (toggled) buttons */
    .highlighted {
      background-color: #007bff !important;
      color: white !important;
      border: 2px solid #0056b3 !important;
    }
    /* Centering buttons */
    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
  </style>
  
  <script>
 async function fetchSentence() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get("mode") || "reasoning";
        const tenses = JSON.parse(sessionStorage.getItem("selectedTenses") || "[]");

        console.log("üìå Fetching a new sentence for mode:", mode);
        console.log("üìå Tenses for conjugation:", tenses);

        const response = await fetch(`/api/ser_estar?mode=${mode}&tenses=${encodeURIComponent(JSON.stringify(tenses))}`);
        const data = await response.json();
        console.log("‚úÖ Received data:", data);

        // ‚úÖ Ensure elements exist before updating them
        const sentenceEl = document.getElementById("sentence");
        const correctEl = document.getElementById("correct");
        const correctCategoryEl = document.getElementById("correctCategory");
        const correctTenseEl = document.getElementById("correctTense");
        const feedbackEl = document.getElementById("feedback");
        const categoryButtons = document.getElementById("categoryButtons");
        const tenseButtonsContainer = document.getElementById("tenseButtonsContainer");

        if (!sentenceEl || !correctEl || !feedbackEl) {
            console.error("‚ùå ERROR: One or more required elements are missing in the DOM.");
            return;
        }

        // ‚úÖ Update the DOM with the new sentence
        sentenceEl.innerText = data.sentence;
        correctEl.value = data.correct ? data.correct.trim().toLowerCase() : ""; // Prevents undefined values

        // ‚úÖ Store correct category if in reasoning mode
        if (mode === "reasoning" && correctCategoryEl) {
            if (data.category) {
                correctCategoryEl.value = data.category.trim(); // ‚úÖ Store category properly
            } else {
                console.error("‚ùå ERROR: Missing category from AI response.");
                correctCategoryEl.value = ""; // ‚úÖ Prevent undefined issues
            }
        }

        // ‚úÖ Store correct tense if in conjugation mode
        if (mode === "conjugation" && correctTenseEl) {
            correctTenseEl.value = data.tense ? data.tense.trim() : ""; // ‚úÖ Store tense properly
        }

        feedbackEl.innerText = ""; // Clear feedback

        // ‚úÖ Hide buttons when fetching a new sentence
        if (categoryButtons) {
            categoryButtons.style.display = "none"; // Hide category buttons on sentence fetch
        }

        if (tenseButtonsContainer) {
            tenseButtonsContainer.style.display = "none"; // Hide tense buttons on sentence fetch
        }

    } catch (error) {
        console.error("‚ùå Error fetching sentence:", error);
    }
}




async function checkAnswer(answer) {
    const correct = document.getElementById("correct").value.trim().toLowerCase();
    const mode = new URLSearchParams(window.location.search).get("mode") || "reasoning";
    const tenseButtonsContainer = document.getElementById("tenseButtonsContainer");

    console.log("üîç Stored correct answer:", correct);
    console.log("üîç User clicked answer:", answer.trim().toLowerCase());

    if (!tenseButtonsContainer) {
        console.error("‚ùå ERROR: Tense buttons container is missing.");
        return;
    }

    if (answer.trim().toLowerCase() === correct) {  // ‚úÖ Trim spaces before comparing
        console.log("‚úÖ Correct answer chosen:", answer.trim().toLowerCase());

        if (mode === "reasoning") {
            console.log("üîπ Reasoning Mode: Showing category buttons.");
            
            document.getElementById("categoryButtons").style.display = "block";
            if (answer.trim().toLowerCase() === "ser") {
                document.getElementById("serSubButtons").style.display = "flex";
                document.getElementById("estarSubButtons").style.display = "none";
            } else {
                document.getElementById("estarSubButtons").style.display = "flex";
                document.getElementById("serSubButtons").style.display = "none";
            }
            
            document.getElementById("feedback").innerText = "‚úÖ Correct! Now select the category.";
            document.getElementById("feedback").className = "feedback correct";

        } else {
            console.log("üîπ Conjugation Mode: Showing tense selection buttons.");
            
            tenseButtonsContainer.style.display = "block";
            generateTenseButtons(JSON.parse(sessionStorage.getItem("selectedTenses") || "[]"));

            document.getElementById("feedback").innerText = "‚úÖ Correct! Now select the tense.";
            document.getElementById("feedback").className = "feedback correct";
        }
    } else {
        console.log("‚ùå Incorrect answer! Fetching new sentence...");

        document.getElementById("categoryButtons").style.display = "none"; 
        tenseButtonsContainer.style.display = "none"; 

        document.getElementById("feedback").innerText = "‚ùå Incorrect!";
        document.getElementById("feedback").className = "feedback incorrect";

        setTimeout(() => {
            fetchSentence();
        }, 1000);
    }
}







function checkCategory(category) {
    const correctCategory = document.getElementById("correctCategory").value.trim(); // ‚úÖ Ensure no spaces

    console.log("üîç User selected category:", category);
    console.log("üìå Correct category from AI:", correctCategory);

    if (category === correctCategory) {
        console.log("üéâ Correct category selected!");

        document.getElementById("feedback").innerText = "‚úÖ Correct!";
        document.getElementById("feedback").className = "feedback correct";

        setTimeout(fetchSentence, 1000);
    } else {
        console.log("‚ùå Incorrect category! Try again.");

        document.getElementById("feedback").innerText = "‚ùå Incorrect! Try again.";
        document.getElementById("feedback").className = "feedback incorrect";
    }
}






function checkTense(selectedTense) {
    const correctTenseEl = document.getElementById("correctTense");
    if (!correctTenseEl) {
        console.error("‚ùå ERROR: `correctTense` hidden input is missing.");
        return;
    }

    // ‚úÖ Normalize both user-selected and AI-generated tense
    const correctTense = correctTenseEl.value.trim().toLowerCase().replace(/_/g, " ");
    const userTense = selectedTense.trim().toLowerCase();

    console.log("‚úÖ User selected tense:", userTense);
    console.log("üìå Correct tense from AI:", correctTense);

    if (userTense === correctTense) {
        console.log("üéâ Correct tense selected!");

        document.getElementById("feedback").innerText = "‚úÖ Correct!";
        document.getElementById("feedback").className = "feedback correct";

        setTimeout(fetchSentence, 1000);
    } else {
        console.log("‚ùå Incorrect tense! Try again.");

        document.getElementById("feedback").innerText = "‚ùå Incorrect! Try again.";
        document.getElementById("feedback").className = "feedback incorrect";
    }
}






function generateTenseButtons(tenses) {
    const tenseButtonsContainer = document.getElementById("tenseButtons");
    if (!tenseButtonsContainer) {
        console.error("‚ùå ERROR: Tense buttons container is missing.");
        return;
    }

    // Clear any existing buttons before generating new ones
    tenseButtonsContainer.innerHTML = "";

    if (!tenses || tenses.length === 0) {
        tenseButtonsContainer.innerHTML = "<p>No tenses selected.</p>";
        return;
    }

    tenses.forEach(tense => {
        const button = document.createElement("button");
        button.classList.add("btn", "btn-outline-primary", "m-2");
        button.innerText = tense;
        button.onclick = () => checkTense(tense);
        tenseButtonsContainer.appendChild(button);
    });

    console.log("‚úÖ Generated tense buttons:", tenses);
}


  </script>
</head>
<body>
  <div class="text-center mt-4">
    <a href="/" class="btn btn-secondary">Home</a>
    <a href="/exercise/ser_estar" class="btn btn-secondary">Back to Exercises</a>
  </div>

  <div class="container text-center">
    <h1 class="mb-4">
      Practice: Ser vs. Estar (<span id="modeDisplay"></span>)
    </h1>
    
<script>
  document.getElementById("practice-mode").innerText = "({{ mode }})";
</script>

  </div>

    <div id="sentence" class="sentence">Loading...</div>
    <input type="hidden" id="correct" />
<input type="hidden" id="correctCategory" />
<input type="hidden" id="correctTense" /> 

    <!-- Ser/Estar Buttons (Used in BOTH Reasoning & Conjugation) -->
<div id="serEstarButtons">
  <h3>Select Ser or Estar:</h3>
  <div class="buttons">
      <button class="btn btn-primary btn-lg" onclick="checkAnswer('ser')">Ser</button>
      <button class="btn btn-secondary btn-lg" onclick="checkAnswer('estar')">Estar</button>
  </div>
</div>

<!-- Sub-buttons for SER & ESTAR (Only for Reasoning Mode) -->
<div id="categoryButtons" style="display: none;">
  <h3>Select the Category:</h3>
  <div id="serSubButtons" class="button-group mt-3" style="display: none;">
      <button class="btn btn-outline-primary" onclick="checkCategory('Identity')">Identity</button>
      <button class="btn btn-outline-success" onclick="checkCategory('Characteristics')">Characteristics</button>
      <button class="btn btn-outline-warning" onclick="checkCategory('Origin/Nationality')">Origin/Nationality</button>
      <button class="btn btn-outline-info" onclick="checkCategory('Time/Date')">Time/Date</button>
      <button class="btn btn-outline-secondary" onclick="checkCategory('Material/Ownership')">Material/Ownership</button>
  </div>

  <div id="estarSubButtons" class="button-group mt-3" style="display: none;">
      <button class="btn btn-outline-primary" onclick="checkCategory('Location')">Location</button>
      <button class="btn btn-outline-success" onclick="checkCategory('Emotions/Conditions')">Emotions/Conditions</button>
      <button class="btn btn-outline-warning" onclick="checkCategory('Ongoing Actions')">Ongoing Actions</button>
      <button class="btn btn-outline-info" onclick="checkCategory('Results of Actions')">Results of Actions</button>
  </div>
</div>

<!-- Tense Selection (Only for Conjugation Mode) -->
<div id="tenseButtonsContainer" style="display: none;">
  <h3>Select the Correct Tense:</h3>
  <div id="tenseButtons" class="button-group mt-3"></div>
</div>

    <div id="feedback" class="feedback"></div>
  </div>
  <script>
document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get("mode") || "reasoning"; // ‚úÖ Declare mode here before using it

    console.log("üìå Practice Mode:", mode); // ‚úÖ No more ReferenceError!

    let selectedTenses = [];
    if (mode === "conjugation") {
        selectedTenses = JSON.parse(sessionStorage.getItem("selectedTenses") || "[]");
        console.log("üìå Selected Tenses in Practice Page:", selectedTenses);
    }

    // ‚úÖ Ensure mode display exists before modifying
    const modeDisplay = document.getElementById("modeDisplay");
    if (modeDisplay) {
        modeDisplay.innerText = mode;
    } else {
        console.error("‚ùå ERROR: modeDisplay element is missing.");
    }

    // ‚úÖ Ensure tense display exists before modifying
    const tenseDisplay = document.getElementById("tenseDisplay");
    if (tenseDisplay) {
        if (selectedTenses.length > 0) {
            tenseDisplay.innerText = "Selected Tenses: " + selectedTenses.join(", ");
        } else {
            tenseDisplay.innerText = "No tenses selected.";
        }
    } else {
        console.error("‚ùå ERROR: tenseDisplay element is missing.");
    }

    // ‚úÖ Generate Tense Buttons (Only for Conjugation Mode)
    if (mode === "conjugation") {
        generateTenseButtons(selectedTenses);
    }

    // ‚úÖ Fetch a new sentence after ensuring everything is set
    fetchSentence();
});


</script>

<div class="container">
    <h2>Practice Mode: <span id="modeDisplay">{{ mode }}</span></h2>
    <p id="tenseDisplay"></p>
</div>

</body>
</html>
